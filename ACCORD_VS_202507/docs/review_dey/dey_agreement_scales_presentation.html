<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Carlos Peralta">
<meta name="dcterms.date" content="2025-07-23">

<title>Agreement Scales for Convective-Scale Ensemble Verification</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="dey_agreement_scales_presentation_files/libs/clipboard/clipboard.min.js"></script>
<script src="dey_agreement_scales_presentation_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="dey_agreement_scales_presentation_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="dey_agreement_scales_presentation_files/libs/quarto-html/popper.min.js"></script>
<script src="dey_agreement_scales_presentation_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="dey_agreement_scales_presentation_files/libs/quarto-html/anchor.min.js"></script>
<link href="dey_agreement_scales_presentation_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="dey_agreement_scales_presentation_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="dey_agreement_scales_presentation_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="dey_agreement_scales_presentation_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="dey_agreement_scales_presentation_files/libs/bootstrap/bootstrap-9810da5fa7c545808853ae26390bbe04.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Agreement Scales for Convective-Scale Ensemble Verification</h1>
<p class="subtitle lead">Spatial Predictability Assessment - Dey et al.&nbsp;(2016)</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Carlos Peralta </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 23, 2025</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">August 18, 2025</p>
    </div>
  </div>
    
  </div>
  


</header>


<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">Motivation</h2>
<p>Modern convective-scale ensembles provide detailed precipitation forecasts, but traditional verification suffers from the <strong>“double penalty”</strong> problem when features are slightly displaced.</p>
<p>When it comes to convective precipitation, what we want to know is:</p>
<ul>
<li><p>Where will <strong>precipitation occur</strong> with confidence?</p></li>
<li><p>What are the <strong>spatial uncertainties</strong> in ensemble forecasts?</p></li>
<li><p>How do we assess <strong>location-dependent predictability</strong>?</p></li>
</ul>
<p><strong>Agreement Scales</strong> by Dey et al.&nbsp;(2016) evaluates the spatial predictability of convective-scale ensembles by calculating neighborhood-based agreement between forecasts at each grid point.</p>
<hr>
</section>
<section id="the-agreement-scales-method" class="level2">
<h2 class="anchored" data-anchor-id="the-agreement-scales-method">The Agreement Scales Method</h2>
<p>Agreement Scales compute location-dependent measures of spatial agreement:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Component</th>
<th>What it measures</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>SA(mm)_ij</td>
<td>Agreement scales between ensemble member pairs</td>
</tr>
<tr class="even">
<td>SA(mo)_ij</td>
<td>Agreement scales between members and observations</td>
</tr>
<tr class="odd">
<td>Spatial Spread</td>
<td>How ensemble members differ spatially</td>
</tr>
<tr class="even">
<td>Spatial Skill</td>
<td>How well ensemble captures observed spatial patterns</td>
</tr>
</tbody>
</table>
<p><strong>Spatial Spread-Skill Relationship:</strong> <span class="math display">\[\text{Compare } SA^{(mm)}_{ij} \text{ with } SA^{(mo)}_{ij}\]</span></p>
<hr>
</section>
<section id="agreement-scale-calculation" class="level2">
<h2 class="anchored" data-anchor-id="agreement-scale-calculation">Agreement Scale Calculation</h2>
<p>The similarity criterion compares forecast fields f₁ and f₂:</p>
<p><span class="math display">\[D^S_{ij} = \begin{cases}
\frac{(f^S_{1ij} - f^S_{2ij})^2}{(f^S_{1ij})^2 + (f^S_{2ij})^2}, &amp; \text{if } f^S_{1ij} &gt; 0 \text{ or } f^S_{2ij} &gt; 0 \\
1, &amp; \text{if } f^S_{1ij} = 0 \text{ and } f^S_{2ij} = 0
\end{cases}\]</span></p>
<p><strong>Agreement Criterion:</strong> <span class="math display">\[D^S_{ij} \leq D^S_{crit,ij} = \alpha + (1-\alpha)\frac{S}{S_{lim}}\]</span></p>
<p>Default parameters: α = 0.5, S_lim = 80 grid points</p>
<hr>
</section>
<section id="python-implementation" class="level2">
<h2 class="anchored" data-anchor-id="python-implementation">Python Implementation</h2>
<div id="42f5fd12" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.ndimage <span class="im">import</span> maximum_filter, minimum_filter</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_similarity_criterion(f1, f2, alpha<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate similarity criterion D between two fields"""</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> f1 <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">or</span> f2 <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (f1 <span class="op">-</span> f2)<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> (f1<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> f2<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> agreement_criterion(scale, alpha<span class="op">=</span><span class="fl">0.5</span>, s_lim<span class="op">=</span><span class="dv">80</span>):</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate agreement criterion threshold"""</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> alpha <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> scale <span class="op">/</span> s_lim</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_agreement_scale(field1, field2, i, j, alpha<span class="op">=</span><span class="fl">0.5</span>, s_lim<span class="op">=</span><span class="dv">80</span>):</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate agreement scale at grid point (i,j) between two fields"""</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    ny, nx <span class="op">=</span> field1.shape</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> scale <span class="kw">in</span> <span class="bu">range</span>(s_lim <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define neighborhood bounds</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        i_min <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, i <span class="op">-</span> scale)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        i_max <span class="op">=</span> <span class="bu">min</span>(ny, i <span class="op">+</span> scale <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        j_min <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, j <span class="op">-</span> scale)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        j_max <span class="op">=</span> <span class="bu">min</span>(nx, j <span class="op">+</span> scale <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate neighborhood averages</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        f1_avg <span class="op">=</span> np.mean(field1[i_min:i_max, j_min:j_max])</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        f2_avg <span class="op">=</span> np.mean(field2[i_min:i_max, j_min:j_max])</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate similarity</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>        d_ij <span class="op">=</span> calculate_similarity_criterion(f1_avg, f2_avg, alpha)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>        d_crit <span class="op">=</span> agreement_criterion(scale, alpha, s_lim)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if agreement criterion is met</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> d_ij <span class="op">&lt;=</span> d_crit:</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> scale</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s_lim</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="agreement-scale-maps-function" class="level2">
<h2 class="anchored" data-anchor-id="agreement-scale-maps-function">Agreement Scale Maps Function</h2>
<div id="063c7cb9" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_agreement_scale_map(field1, field2, alpha<span class="op">=</span><span class="fl">0.5</span>, s_lim<span class="op">=</span><span class="dv">80</span>):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate agreement scale map between two precipitation fields"""</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    ny, nx <span class="op">=</span> field1.shape</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    agreement_map <span class="op">=</span> np.zeros((ny, nx))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(ny):</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(nx):</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>            agreement_map[i, j] <span class="op">=</span> calculate_agreement_scale(</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                field1, field2, i, j, alpha, s_lim</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> agreement_map</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_ensemble_agreement_scales(ensemble_fields, alpha<span class="op">=</span><span class="fl">0.5</span>, s_lim<span class="op">=</span><span class="dv">80</span>):</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate SA(mm) from ensemble member pairs"""</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    n_members <span class="op">=</span> <span class="bu">len</span>(ensemble_fields)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    ny, nx <span class="op">=</span> ensemble_fields[<span class="dv">0</span>].shape</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate agreement scales for all member pairs</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    agreement_scales <span class="op">=</span> []</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_members):</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, n_members):</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>            scale_map <span class="op">=</span> calculate_agreement_scale_map(</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                ensemble_fields[i], ensemble_fields[j], alpha, s_lim</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>            agreement_scales.append(scale_map)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average over all pairs</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    sa_mm <span class="op">=</span> np.mean(agreement_scales, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sa_mm</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_member_obs_agreement_scales(ensemble_fields, observations, alpha<span class="op">=</span><span class="fl">0.5</span>, s_lim<span class="op">=</span><span class="dv">80</span>):</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate SA(mo) between ensemble members and observations"""</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    agreement_scales <span class="op">=</span> []</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> member_field <span class="kw">in</span> ensemble_fields:</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        scale_map <span class="op">=</span> calculate_agreement_scale_map(</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>            member_field, observations, alpha, s_lim</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        agreement_scales.append(scale_map)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average over all members</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    sa_mo <span class="op">=</span> np.mean(agreement_scales, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sa_mo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="creating-synthetic-ensemble-data" class="level2">
<h2 class="anchored" data-anchor-id="creating-synthetic-ensemble-data">Creating Synthetic Ensemble Data</h2>
<div id="53c8f2a5" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_synthetic_precipitation_ensemble(nx<span class="op">=</span><span class="dv">100</span>, ny<span class="op">=</span><span class="dv">100</span>, n_members<span class="op">=</span><span class="dv">12</span>):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create synthetic ensemble precipitation fields"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    ensemble <span class="op">=</span> []</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Base precipitation pattern</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    base_field <span class="op">=</span> np.zeros((ny, nx))</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add convective cells with spatial uncertainty</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    cell_centers <span class="op">=</span> [(<span class="dv">25</span>, <span class="dv">35</span>), (<span class="dv">65</span>, <span class="dv">75</span>), (<span class="dv">45</span>, <span class="dv">20</span>)]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    cell_intensities <span class="op">=</span> [<span class="fl">15.0</span>, <span class="fl">10.0</span>, <span class="fl">8.0</span>]</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> member <span class="kw">in</span> <span class="bu">range</span>(n_members):</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        field <span class="op">=</span> np.zeros((ny, nx))</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (cy, cx), intensity <span class="kw">in</span> <span class="bu">zip</span>(cell_centers, cell_intensities):</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add spatial displacement for each member</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>            dy <span class="op">=</span> np.random.randint(<span class="op">-</span><span class="dv">5</span>, <span class="dv">6</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>            dx <span class="op">=</span> np.random.randint(<span class="op">-</span><span class="dv">5</span>, <span class="dv">6</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add intensity variation</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>            member_intensity <span class="op">=</span> intensity <span class="op">*</span> np.random.uniform(<span class="fl">0.7</span>, <span class="fl">1.3</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create precipitation cell</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>            y_center <span class="op">=</span> <span class="bu">max</span>(<span class="dv">5</span>, <span class="bu">min</span>(ny<span class="op">-</span><span class="dv">5</span>, cy <span class="op">+</span> dy))</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>            x_center <span class="op">=</span> <span class="bu">max</span>(<span class="dv">5</span>, <span class="bu">min</span>(nx<span class="op">-</span><span class="dv">5</span>, cx <span class="op">+</span> dx))</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Gaussian-like precipitation pattern</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>            y_indices, x_indices <span class="op">=</span> np.ogrid[:ny, :nx]</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>            distances <span class="op">=</span> np.sqrt((y_indices <span class="op">-</span> y_center)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (x_indices <span class="op">-</span> x_center)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>            cell_pattern <span class="op">=</span> member_intensity <span class="op">*</span> np.exp(<span class="op">-</span>distances<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> <span class="dv">3</span><span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Only keep significant precipitation</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>            cell_pattern[cell_pattern <span class="op">&lt;</span> <span class="fl">0.5</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>            field <span class="op">+=</span> cell_pattern</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        ensemble.append(field)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ensemble</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Create synthetic ensemble</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>ensemble_fields <span class="op">=</span> create_synthetic_precipitation_ensemble()</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Created ensemble with </span><span class="sc">{</span><span class="bu">len</span>(ensemble_fields)<span class="sc">}</span><span class="ss"> members"</span>)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Field shape: </span><span class="sc">{</span>ensemble_fields[<span class="dv">0</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Created ensemble with 12 members
Field shape: (100, 100)</code></pre>
</div>
</div>
<hr>
</section>
<section id="creating-synthetic-observations" class="level2">
<h2 class="anchored" data-anchor-id="creating-synthetic-observations">Creating Synthetic Observations</h2>
<div id="340ea5f5" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_synthetic_observations(nx<span class="op">=</span><span class="dv">100</span>, ny<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create synthetic radar observations"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">123</span>)  <span class="co"># Different seed for observations</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    obs_field <span class="op">=</span> np.zeros((ny, nx))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># True precipitation locations (with some displacement from ensemble mean)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    true_centers <span class="op">=</span> [(<span class="dv">28</span>, <span class="dv">32</span>), (<span class="dv">62</span>, <span class="dv">78</span>), (<span class="dv">42</span>, <span class="dv">18</span>)]</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    true_intensities <span class="op">=</span> [<span class="fl">12.0</span>, <span class="fl">11.0</span>, <span class="fl">6.0</span>]</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (cy, cx), intensity <span class="kw">in</span> <span class="bu">zip</span>(true_centers, true_intensities):</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create precipitation cell</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        y_indices, x_indices <span class="op">=</span> np.ogrid[:ny, :nx]</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        distances <span class="op">=</span> np.sqrt((y_indices <span class="op">-</span> cy)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (x_indices <span class="op">-</span> cx)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        cell_pattern <span class="op">=</span> intensity <span class="op">*</span> np.exp(<span class="op">-</span>distances<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> <span class="dv">3</span><span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Only keep significant precipitation</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        cell_pattern[cell_pattern <span class="op">&lt;</span> <span class="fl">0.5</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        obs_field <span class="op">+=</span> cell_pattern</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> obs_field</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Create synthetic observations</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>observations <span class="op">=</span> create_synthetic_observations()</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Observation field shape: </span><span class="sc">{</span>observations<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Max precipitation: </span><span class="sc">{</span>observations<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.1f}</span><span class="ss"> mm/h"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Observation field shape: (100, 100)
Max precipitation: 12.0 mm/h</code></pre>
</div>
</div>
<hr>
</section>
<section id="visualizing-ensemble-and-observations" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-ensemble-and-observations">Visualizing Ensemble and Observations</h2>
<div id="13f3642e" class="cell" data-fig-height="10" data-fig-width="15" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot first 3 ensemble members</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    im <span class="op">=</span> axes[<span class="dv">0</span>, i].imshow(ensemble_fields[i], cmap<span class="op">=</span><span class="st">'Blues'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>, i].set_title(<span class="ss">f'Ensemble Member </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>, i].set_xlabel(<span class="st">'Grid X'</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>, i].set_ylabel(<span class="st">'Grid Y'</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(im, ax<span class="op">=</span>axes[<span class="dv">0</span>, i], label<span class="op">=</span><span class="st">'Precipitation (mm/h)'</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot observations and ensemble mean</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>obs_im <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">0</span>].imshow(observations, cmap<span class="op">=</span><span class="st">'Blues'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Radar Observations'</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Grid X'</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Grid Y'</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>plt.colorbar(obs_im, ax<span class="op">=</span>axes[<span class="dv">1</span>, <span class="dv">0</span>], label<span class="op">=</span><span class="st">'Precipitation (mm/h)'</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensemble mean</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>ensemble_mean <span class="op">=</span> np.mean(ensemble_fields, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>mean_im <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">1</span>].imshow(ensemble_mean, cmap<span class="op">=</span><span class="st">'Blues'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Ensemble Mean'</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Grid X'</span>)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Grid Y'</span>)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>plt.colorbar(mean_im, ax<span class="op">=</span>axes[<span class="dv">1</span>, <span class="dv">1</span>], label<span class="op">=</span><span class="st">'Precipitation (mm/h)'</span>)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensemble standard deviation</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>ensemble_std <span class="op">=</span> np.std(ensemble_fields, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>std_im <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">2</span>].imshow(ensemble_std, cmap<span class="op">=</span><span class="st">'Reds'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">2</span>].set_title(<span class="st">'Ensemble Standard Deviation'</span>)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">2</span>].set_xlabel(<span class="st">'Grid X'</span>)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">2</span>].set_ylabel(<span class="st">'Grid Y'</span>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>plt.colorbar(std_im, ax<span class="op">=</span>axes[<span class="dv">1</span>, <span class="dv">2</span>], label<span class="op">=</span><span class="st">'Std Dev (mm/h)'</span>)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="dey_agreement_scales_presentation_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="calculating-agreement-scales" class="level2">
<h2 class="anchored" data-anchor-id="calculating-agreement-scales">Calculating Agreement Scales</h2>
<div id="94d111d1" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate SA(mm) - agreement between ensemble members</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Calculating SA(mm) - ensemble member agreement scales..."</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>sa_mm <span class="op">=</span> calculate_ensemble_agreement_scales(ensemble_fields)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate SA(mo) - agreement between members and observations</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Calculating SA(mo) - member-observation agreement scales..."</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>sa_mo <span class="op">=</span> calculate_member_obs_agreement_scales(ensemble_fields, observations)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Agreement scale calculations completed!"</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"SA(mm) range: </span><span class="sc">{</span>sa_mm<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.1f}</span><span class="ss"> to </span><span class="sc">{</span>sa_mm<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.1f}</span><span class="ss"> grid points"</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"SA(mo) range: </span><span class="sc">{</span>sa_mo<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.1f}</span><span class="ss"> to </span><span class="sc">{</span>sa_mo<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.1f}</span><span class="ss"> grid points"</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Domain average SA(mm): </span><span class="sc">{</span>sa_mm<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ss"> grid points"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Domain average SA(mo): </span><span class="sc">{</span>sa_mo<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ss"> grid points"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Calculating SA(mm) - ensemble member agreement scales...
Calculating SA(mo) - member-observation agreement scales...
Agreement scale calculations completed!
SA(mm) range: 0.1 to 59.4 grid points
SA(mo) range: 0.0 to 58.2 grid points
Domain average SA(mm): 21.2 grid points
Domain average SA(mo): 21.4 grid points</code></pre>
</div>
</div>
<hr>
</section>
<section id="visualizing-agreement-scale-maps" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-agreement-scale-maps">Visualizing Agreement Scale Maps</h2>
<div id="b1b18e98" class="cell" data-fig-height="5" data-fig-width="12" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2, ax3) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">4</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot SA(mm)</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>im1 <span class="op">=</span> ax1.imshow(sa_mm, cmap<span class="op">=</span><span class="st">'viridis_r'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">80</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'SA(mm): Member-Member Agreement Scales'</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Grid X'</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Grid Y'</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>plt.colorbar(im1, ax<span class="op">=</span>ax1, label<span class="op">=</span><span class="st">'Agreement Scale (grid points)'</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot SA(mo)</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>im2 <span class="op">=</span> ax2.imshow(sa_mo, cmap<span class="op">=</span><span class="st">'viridis_r'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">80</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'SA(mo): Member-Observation Agreement Scales'</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Grid X'</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Grid Y'</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>plt.colorbar(im2, ax<span class="op">=</span>ax2, label<span class="op">=</span><span class="st">'Agreement Scale (grid points)'</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot difference (SA(mo) - SA(mm))</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>diff <span class="op">=</span> sa_mo <span class="op">-</span> sa_mm</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>im3 <span class="op">=</span> ax3.imshow(diff, cmap<span class="op">=</span><span class="st">'RdBu_r'</span>, vmin<span class="op">=-</span><span class="dv">20</span>, vmax<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>ax3.set_title(<span class="st">'SA(mo) - SA(mm): Spread-Skill Difference'</span>)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>ax3.set_xlabel(<span class="st">'Grid X'</span>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>ax3.set_ylabel(<span class="st">'Grid Y'</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>plt.colorbar(im3, ax<span class="op">=</span>ax3, label<span class="op">=</span><span class="st">'Difference (grid points)'</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="dey_agreement_scales_presentation_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="spatial-spread-skill-analysis" class="level2">
<h2 class="anchored" data-anchor-id="spatial-spread-skill-analysis">Spatial Spread-Skill Analysis</h2>
<div id="2931330c" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_binned_scatter_plot(sa_mm, sa_mo, bin_size<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create binned scatter plot for spread-skill analysis"""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flatten arrays</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    sa_mm_flat <span class="op">=</span> sa_mm.flatten()</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    sa_mo_flat <span class="op">=</span> sa_mo.flatten()</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create bins</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    max_scale <span class="op">=</span> <span class="bu">max</span>(sa_mm_flat.<span class="bu">max</span>(), sa_mo_flat.<span class="bu">max</span>())</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    bins <span class="op">=</span> np.arange(<span class="dv">0</span>, max_scale <span class="op">+</span> bin_size, bin_size)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    bin_centers <span class="op">=</span> []</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    sa_mm_binned <span class="op">=</span> []</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    sa_mo_binned <span class="op">=</span> []</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(bins) <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find points in this bin based on SA(mm)</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> (sa_mm_flat <span class="op">&gt;=</span> bins[i]) <span class="op">&amp;</span> (sa_mm_flat <span class="op">&lt;</span> bins[i <span class="op">+</span> <span class="dv">1</span>])</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.<span class="bu">sum</span>(mask) <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Only include bins with data</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>            bin_centers.append((bins[i] <span class="op">+</span> bins[i <span class="op">+</span> <span class="dv">1</span>]) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>            sa_mm_binned.append(np.mean(sa_mm_flat[mask]))</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>            sa_mo_binned.append(np.mean(sa_mo_flat[mask]))</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(bin_centers), np.array(sa_mm_binned), np.array(sa_mo_binned)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Create binned scatter plot</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>bin_centers, sa_mm_binned, sa_mo_binned <span class="op">=</span> create_binned_scatter_plot(sa_mm, sa_mo)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot results</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>plt.plot(sa_mm_binned, sa_mo_binned, <span class="st">'bo-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">8</span>, label<span class="op">=</span><span class="st">'Binned Data'</span>)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="dv">80</span>], [<span class="dv">0</span>, <span class="dv">80</span>], <span class="st">'k--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span><span class="st">'Perfect Spread-Skill (1:1 line)'</span>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Mean SA(mm) (grid points)'</span>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Mean SA(mo) (grid points)'</span>)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Spatial Spread-Skill Relationship'</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>, <span class="dv">80</span>)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="dv">0</span>, <span class="dv">80</span>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Add interpretation text</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> np.mean(sa_mo_binned) <span class="op">&gt;</span> np.mean(sa_mm_binned):</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    plt.text(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="st">'Ensemble appears UNDER-SPREAD</span><span class="ch">\n</span><span class="st">(SA(mo) &gt; SA(mm))'</span>, </span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>             transform<span class="op">=</span>plt.gca().transAxes, verticalalignment<span class="op">=</span><span class="st">'top'</span>,</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>             bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'lightcoral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>))</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    plt.text(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="st">'Ensemble appears OVER-SPREAD</span><span class="ch">\n</span><span class="st">(SA(mo) &lt; SA(mm))'</span>, </span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>             transform<span class="op">=</span>plt.gca().transAxes, verticalalignment<span class="op">=</span><span class="st">'top'</span>,</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>             bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'lightblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>))</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="dey_agreement_scales_presentation_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="statistical-summary" class="level2">
<h2 class="anchored" data-anchor-id="statistical-summary">Statistical Summary</h2>
<div id="61cea82d" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate domain statistics</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>domain_sa_mm <span class="op">=</span> np.mean(sa_mm)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>domain_sa_mo <span class="op">=</span> np.mean(sa_mo)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>correlation <span class="op">=</span> np.corrcoef(sa_mm.flatten(), sa_mo.flatten())[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate spread-skill metrics</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>spread_skill_diff <span class="op">=</span> sa_mo <span class="op">-</span> sa_mm</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>mean_diff <span class="op">=</span> np.mean(spread_skill_diff)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>rmse_diff <span class="op">=</span> np.sqrt(np.mean(spread_skill_diff<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== Agreement Scales Summary ==="</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Domain Average SA(mm): </span><span class="sc">{</span>domain_sa_mm<span class="sc">:.2f}</span><span class="ss"> grid points"</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Domain Average SA(mo): </span><span class="sc">{</span>domain_sa_mo<span class="sc">:.2f}</span><span class="ss"> grid points"</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean Difference (SA(mo) - SA(mm)): </span><span class="sc">{</span>mean_diff<span class="sc">:.2f}</span><span class="ss"> grid points"</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"RMSE of Difference: </span><span class="sc">{</span>rmse_diff<span class="sc">:.2f}</span><span class="ss"> grid points"</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Spatial Correlation: </span><span class="sc">{</span>correlation<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Interpretation</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> mean_diff <span class="op">&gt;</span> <span class="dv">2</span>:</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🔴 INTERPRETATION: Ensemble appears UNDER-SPREAD"</span>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"   → Ensemble members are too similar to each other"</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"   → Real spatial uncertainty is larger than ensemble suggests"</span>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> mean_diff <span class="op">&lt;</span> <span class="op">-</span><span class="dv">2</span>:</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🔵 INTERPRETATION: Ensemble appears OVER-SPREAD"</span>) </span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"   → Ensemble members are too different from each other"</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"   → Ensemble overestimates spatial uncertainty"</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🟢 INTERPRETATION: Ensemble appears WELL-SPREAD"</span>)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"   → Good balance between ensemble spread and skill"</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== Precipitation Coverage Analysis ==="</span>)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate precipitation coverage</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>precip_threshold <span class="op">=</span> <span class="fl">0.5</span>  <span class="co"># mm/h</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>obs_coverage <span class="op">=</span> np.<span class="bu">sum</span>(observations <span class="op">&gt;</span> precip_threshold) <span class="op">/</span> observations.size <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>ensemble_coverage <span class="op">=</span> [np.<span class="bu">sum</span>(field <span class="op">&gt;</span> precip_threshold) <span class="op">/</span> field.size <span class="op">*</span> <span class="dv">100</span> </span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> field <span class="kw">in</span> ensemble_fields]</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>mean_ensemble_coverage <span class="op">=</span> np.mean(ensemble_coverage)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Observed precipitation coverage: </span><span class="sc">{</span>obs_coverage<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean ensemble precipitation coverage: </span><span class="sc">{</span>mean_ensemble_coverage<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Coverage bias: </span><span class="sc">{</span>mean_ensemble_coverage <span class="op">-</span> obs_coverage<span class="sc">:.1f}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Agreement Scales Summary ===
Domain Average SA(mm): 21.24 grid points
Domain Average SA(mo): 21.38 grid points
Mean Difference (SA(mo) - SA(mm)): 0.13 grid points
RMSE of Difference: 1.40 grid points
Spatial Correlation: 0.993

🟢 INTERPRETATION: Ensemble appears WELL-SPREAD
   → Good balance between ensemble spread and skill

=== Precipitation Coverage Analysis ===
Observed precipitation coverage: 4.9%
Mean ensemble precipitation coverage: 5.2%
Coverage bias: 0.3%</code></pre>
</div>
</div>
<hr>
</section>
<section id="interpretation-guidelines" class="level2">
<h2 class="anchored" data-anchor-id="interpretation-guidelines">Interpretation Guidelines</h2>
<p><strong>Agreement Scale Ranges:</strong></p>
<ul>
<li><p><strong>0-10 grid points</strong>: High spatial predictability, precipitation location well constrained</p></li>
<li><p><strong>10-30 grid points</strong>: Moderate spatial uncertainty, neighborhood approach needed</p></li>
<li><p><strong>30-50 grid points</strong>: Large spatial uncertainty, broad areas of possible precipitation</p></li>
<li><p><strong>50+ grid points</strong>: Very low spatial predictability or dry regions</p></li>
</ul>
<p><strong>Spread-Skill Relationship:</strong></p>
<ul>
<li><p><strong>SA(mo) &gt; SA(mm)</strong>: <strong>Under-spread</strong> ensemble - members too similar, underestimates uncertainty</p></li>
<li><p><strong>SA(mo) ≈ SA(mm)</strong>: <strong>Well-spread</strong> ensemble - good representation of spatial uncertainty</p></li>
<li><p><strong>SA(mo) &lt; SA(mm)</strong>: <strong>Over-spread</strong> ensemble - members too different, overestimates uncertainty</p></li>
</ul>
<p><strong>Physical Interpretation:</strong> - Small agreement scales near precipitation indicate <strong>high spatial predictability</strong></p>
<ul>
<li><p>Large agreement scales indicate <strong>low spatial predictability</strong> or distance from precipitation</p></li>
<li><p>Topographic effects often reduce agreement scales (higher predictability)</p></li>
</ul>
<hr>
</section>
<section id="practical-applications" class="level2">
<h2 class="anchored" data-anchor-id="practical-applications">Practical Applications</h2>
<p><strong>Operational Verification:</strong></p>
<ul>
<li><p>Assess spatial ensemble performance routinely</p></li>
<li><p>Identify systematic biases in precipitation placement</p></li>
<li><p>Compare different ensemble configurations</p></li>
<li><p>Monitor ensemble calibration over time</p></li>
</ul>
<p><strong>Forecast Applications:</strong></p>
<ul>
<li><p>Provide location-dependent uncertainty estimates</p></li>
<li><p>Support probabilistic precipitation forecasts</p></li>
<li><p>Guide forecast interpretation and decision-making</p></li>
<li><p>Identify high/low confidence regions</p></li>
</ul>
<p><strong>Research Applications:</strong></p>
<ul>
<li><p>Understand ensemble behavior in different weather regimes</p></li>
<li><p>Evaluate impact of model changes on spatial predictability</p></li>
<li><p>Study relationship between physical processes and predictability</p></li>
<li><p>Develop improved ensemble perturbation strategies</p></li>
</ul>
<hr>
</section>
<section id="key-advantages-of-agreement-scales" class="level2">
<h2 class="anchored" data-anchor-id="key-advantages-of-agreement-scales">Key Advantages of Agreement Scales</h2>
<ol type="1">
<li><p><strong>Location-dependent</strong> - preserves spatial information unlike domain-wide metrics</p></li>
<li><p><strong>Scale-aware</strong> - identifies appropriate neighborhood sizes for verification</p></li>
<li><p><strong>Physically meaningful</strong> - links to meteorological processes and predictability</p></li>
<li><p><strong>Ensemble-specific</strong> - designed for convective-scale ensemble evaluation</p></li>
<li><p><strong>Flexible</strong> - applicable to different precipitation thresholds and variables</p></li>
</ol>
<p><strong>Complements existing methods</strong> like FSS (Fractions Skill Score) and traditional ensemble verification</p>
<p><strong>Addresses double penalty problem</strong> through neighborhood-based approach</p>
</section>
<section id="differences-between-the-agreement-scales-and-the-fss" class="level2">
<h2 class="anchored" data-anchor-id="differences-between-the-agreement-scales-and-the-fss">Differences between the Agreement Scales and the FSS</h2>
<section id="fraction-skill-score-fss" class="level3">
<h3 class="anchored" data-anchor-id="fraction-skill-score-fss">Fraction Skill Score (FSS)</h3>
<ul>
<li><p><em>Purpose</em>: Quantifies the overall similarity between a forecast and an observation field, after both have been smoothed using a neighbourhood approach.</p></li>
<li><p><em>How it works</em>: Both the forecast and observed fields are converted into binary maps (e.g., rainfall above/below a threshold). For each location, the fraction of points exceeding the threshold within a neighbourhood is computed. The FSS then measures the mean squared difference between these fractions for the forecast and observations, normalized so that a value of 1 represents perfect skill and 0 represents no skill.</p></li>
<li><p><em>Interpretation</em>: FSS is domain-averaged, meaning it tells you how good your forecast is across the whole area at a given spatial scale. You can use FSS to determine the minimum scale at which the forecast is deemed “skillful” (typically when FSS &gt; 0.5 or other empirical thresholds).</p></li>
</ul>
</section>
<section id="agreement-scales-score" class="level3">
<h3 class="anchored" data-anchor-id="agreement-scales-score">Agreement Scales Score</h3>
<ul>
<li><p><em>Purpose</em>: Provides a location-specific measure of similarity between forecasts (or ensemble members) and observations, quantifying the spatial scale at which different fields agree.</p></li>
<li><p><em>How it works</em>: For each grid point, the method finds the size of the square neighbourhood over which the forecast and observed fields meet a predefined similarity criterion (often based on their local agreement in binary precipitation features). The resulting “agreement scale” at each location tells you how large an area you’d need to average before the forecast and observation become “close enough” in that region.</p></li>
<li><p><em>Interpretation</em>: Unlike the FSS, agreement scales allow you to see where in the domain agreement is better/worse, providing a map of local forecast reliability. This is valuable for diagnosing forecast skill and uncertainty at specific locations and for understanding how ensemble spread varies in space.</p></li>
</ul>
<hr>
</section>
</section>
<section id="references-resources" class="level2">
<h2 class="anchored" data-anchor-id="references-resources">References &amp; Resources</h2>
<p><strong>Primary References:</strong></p>
<ul>
<li><p>Dey, S.R.A., et al.&nbsp;(2016). A new method for the characterization and verification of local spatial predictability for convective-scale ensembles. <em>Q.J.R. Meteorol. Soc.</em>, 142, 1982-1996.</p></li>
<li><p>Dey, S.R.A., et al.&nbsp;(2016). Assessing spatial precipitation uncertainties in a convective-scale ensemble. <em>Q.J.R. Meteorol. Soc.</em>, 142, 2935-2948.</p></li>
</ul>
<p><strong>Related Methods:</strong></p>
<ul>
<li><p>Roberts &amp; Lean (2008): Fractions Skill Score (FSS)</p></li>
<li><p>Clark et al.&nbsp;(2011): Ensemble verification at convective scales</p></li>
<li><p>Johnson et al.&nbsp;(2014): Multiscale ensemble characteristics</p></li>
</ul>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>