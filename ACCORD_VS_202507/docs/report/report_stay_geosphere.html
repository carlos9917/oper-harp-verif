<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Carlos Peralta, Polly Schmederer and Philipp Scheffknecht">
<meta name="dcterms.date" content="2025-08-11">

<title>Report on ACCORD VS at GeoSphere</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="report_stay_geosphere_files/libs/clipboard/clipboard.min.js"></script>
<script src="report_stay_geosphere_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="report_stay_geosphere_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="report_stay_geosphere_files/libs/quarto-html/popper.min.js"></script>
<script src="report_stay_geosphere_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="report_stay_geosphere_files/libs/quarto-html/anchor.min.js"></script>
<link href="report_stay_geosphere_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="report_stay_geosphere_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="report_stay_geosphere_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="report_stay_geosphere_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="report_stay_geosphere_files/libs/bootstrap/bootstrap-9810da5fa7c545808853ae26390bbe04.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="report_stay_geosphere.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Report on ACCORD VS at GeoSphere</h1>
<p class="subtitle lead">Implementation and Validation of Spatial Verification Methods for Extreme Events</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Carlos Peralta, Polly Schmederer and Philipp Scheffknecht </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 11, 2025</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">August 18, 2025</p>
    </div>
  </div>
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>During a three-week scientific visit at GeoSphere, the main focus was the <strong>implementation and validation of spatial verification methods</strong> for high-impact meteorological forecast assessment, particularly for extreme weather events. This work contributed to the ACCORD MQA initiative, targeting operational model evaluation and development using the <code>harp</code> package.</p>
</section>
<section id="general-review-of-verification-methods" class="level1">
<h1>General Review of Verification Methods</h1>
<p>A comprehensive review of advanced spatial verification techniques set the context for evaluating high-resolution weather forecasts, especially regarding the challenge of location-dependent forecast errors and the “double penalty” effect <span class="citation" data-cites="slx_presentation">(<a href="#ref-slx_presentation" role="doc-biblioref">Sass 2021</a>)</span>.</p>
<section id="slx-score" class="level3">
<h3 class="anchored" data-anchor-id="slx-score">SLX Score</h3>
</section>
<section id="method-summary" class="level2">
<h2 class="anchored" data-anchor-id="method-summary">Method Summary</h2>
<p>The <strong>SLX score</strong> was implemented to quantify the similarity between forecast and observed fields, systematically reducing penalties for small spatial displacement errors <span class="citation" data-cites="slx_validation">(<a href="#ref-slx_validation" role="doc-biblioref">Peralta 2025b</a>)</span>.</p>
<ul>
<li><strong>Key properties:</strong></li>
<li>Focuses on matching patterns and features within spatial neighborhoods.</li>
<li>Sensitive to both the location and the structure of extreme events.</li>
<li>Effective for high-resolution forecasts where traditional point-by-point metrics fail.</li>
</ul>
<section id="agreement-scales-score-dey-method" class="level3">
<h3 class="anchored" data-anchor-id="agreement-scales-score-dey-method">Agreement Scales Score (Dey Method)</h3>
</section>
</section>
<section id="method-summary-1" class="level2">
<h2 class="anchored" data-anchor-id="method-summary-1">Method Summary</h2>
<p>The <strong>Agreement Scales Score</strong> identifies the smallest neighborhood size at which forecast and observation fields “agree”, mapping scale-dependent skill and uncertainty [<span class="citation" data-cites="review_dey">Dey (<a href="#ref-review_dey" role="doc-biblioref">2016</a>)</span>]<span class="citation" data-cites="dey_validation">(<a href="#ref-dey_validation" role="doc-biblioref">Peralta 2025a</a>)</span>.</p>
<ul>
<li><strong>Key properties:</strong></li>
<li>Produces spatial maps of agreement scale.</li>
<li>Reveals local skill variations and ensemble spread.</li>
<li>Enables targeted verification of prediction uncertainty for extremes.</li>
</ul>
</section>
<section id="case-studies" class="level2">
<h2 class="anchored" data-anchor-id="case-studies">Case studies</h2>
<section id="case-1-convection-driven-event-on-july-28-2025-austria-domain" class="level3">
<h3 class="anchored" data-anchor-id="case-1-convection-driven-event-on-july-28-2025-austria-domain">Case 1: Convection driven event on July 28 2025 (Austria domain)</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../case_studies/geosphere/2025072815_convection_case/ob_accrr3h_202507281800_INCAPlus.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>3h accumulated precipitation from INCAPlus gridded data for the July 28 2025 event</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../case_studies/geosphere/2025072815_convection_case/fc_accrr1h_202507281800_3_CLAEF00.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>3h accumulated precipitation from CLAEF 1km member 0 for the July 28 2025 event</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../case_studies/geosphere/2025072815_convection_case/slx_overall_2025072815_3_accrr3h.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>Overall SLX scores for the convection driven event</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../case_studies/geosphere/2025072815_convection_case/slx_comps_2025072815_3_accrr3h.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>Individual SLX scores for the convection driven event</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../case_studies/geosphere/2025072815_convection_case/fo_field_plots.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption>Agreement scale map for forecast versus observation of a convective event</figcaption>
</figure>
</div>
</section>
<section id="case-2-orographically-driven-precipitation-event-on-july-8-2025-austria-domain" class="level3">
<h3 class="anchored" data-anchor-id="case-2-orographically-driven-precipitation-event-on-july-8-2025-austria-domain">Case 2: Orographically driven precipitation event on July 8 2025 (Austria domain)</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../case_studies/geosphere/2025070800_orog_case/ob_accrr3h_202507080300_INCAPlus.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>3h accumulated precipitation from INCAPlus gridded data for the July 8 2025 event</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../case_studies/geosphere/2025070800_orog_case/fc_accrr3h_202507080300_3_CLAEF00.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>3h accumulated precipitation from CLAEF 1km member 0 for the July 8 2025 event</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../case_studies/geosphere/2025070800_orog_case/slx_overall_2025070800_3_accrr3h.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>Overall SLX scores for the orographic driven event</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../case_studies/geosphere/2025070800_orog_case/slx_comps_2025070800_3_accrr3h.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>Individual SLX scores for the orographic driven event</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../case_studies/geosphere/2025070800_orog_case/fo_field_plots.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption>Agreement scale map for forecast versus observation of an orographically driven precipitation event</figcaption>
</figure>
</div>
</section>
</section>
</section>
<section id="summary-of-results" class="level1">
<h1>Summary of results</h1>
<p>The two case studies illustrate the added value of the spatial verification methods implemented here.</p>
<section id="summary-of-slx-scores-for-the-convection-driven-case" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-slx-scores-for-the-convection-driven-case">Summary of SLX scores for the convection-driven case</h2>
<ul>
<li><p>The combined SLX score starts around 0.45 at the grid scale (L=0). With increasing neighborhood size (L=5–20), the score climbs gently, reaching ~0.52.</p></li>
<li><p>The forecasts remain in the moderate range throughout, but trending upward with smoothing. This means that, even at grid scale, the forecast has non‑zero pattern similarity, but it is clearly penalized for displacement errors. As neighborhoods grow, SLX improves slightly, showing that the model has correct structures but shifted. However, the fact that it does not enter the “Good” category suggests location errors are widespread enough to limit skill beyond moderate quality.</p></li>
<li><p>Looking at the individual components of SLX, the obs minima are very high (0.8–0.85), stable across scales. This means observed rainfall minima (dry areas) are consistently well represented in the forecast (little “false rain”).</p></li>
<li><p>Observation Maxima are in the mid‑range (0.38–0.42 initially, decreasing slightly with scale). Observed maxima are only partly captured, and location/intensity mismatches with forecast hamper this component.</p></li>
<li><p>Forecast minina starts lower (~0.3) but rises steadily with scale, reaching ~0.8. This shows that forecasted minima gradually find correspondence in observations once neighborhoods are widened.</p></li>
<li><p>Forecast maxima show very poor agreement (&lt;0.35 at L=0, dropping quickly towards ~0 by L=20). This indicates that forecast precipitation maxima do not collocate with observed maxima, even when neighborhoods are allowed. The model placed rain maxima, but not where reality did.</p></li>
</ul>
</section>
<section id="summary-of-agrement-scales-for-the-convection-driven-case" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-agrement-scales-for-the-convection-driven-case">Summary of agrement scales for the convection-driven case</h2>
<ul>
<li><p>The field plots show that the forecast captures that a precipitation event occurred with similar spatial organization, but the location is shifted and fine-scale spatial detail is poorly aligned.</p></li>
<li><p>The agreement scales map shows the spatial field of the minimum neighborhood size (in grid points) needed for observations and forecast to “agree”. Darker reds (low values) are scarce — meaning only a few patches show agreement at very fine scales. Yellows/whites (large scales) dominate in central and southern parts of the domain, implying that only when the comparison window is broadened substantially (40–60+ grid points) do forecast and observed fields match.</p></li>
<li><p>The histogram shows a strong spike near zero indicates a subset of grid points with nearly perfect local agreement. That likely corresponds to regions with weak/no precipitation in both forecast and observation. There is a deep between ~5–20 grid points,indicating fewer areas of small-scale agreement. A secondary hump at ~60–70 grid points shows a significant fraction of the domain requires very broad neighborhoods before forecast and observed align — consistent with displaced but pattern‑similar rainfall. Mean agreement scale (red dashed line): Around ~38 grid points. This is very large, implying that over much of the domain, useful forecast skill only appears when smoothed to a mesoscale scale.</p></li>
</ul>
<p>Summary: This analysis shows that while the event was well captured in a mesoscale sense, the model struggled with fine-scale localization — agreement only emerges at large neighborhood scales, consistent with systematic displacement along terrain.</p>
</section>
<section id="summary-of-slx-scores-for-the-orographically-driven-case" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-slx-scores-for-the-orographically-driven-case">Summary of SLX scores for the orographically driven case</h2>
<ul>
<li><p>Overall the SLX skill is highest at the grid scale and degrades as L increases: about 0.65 at L=0 (just at/above the “Good” threshold), then ~0.62 (L=5), ~0.55 (L=10), ~0.50 (L=15), and ~0.45 (L=20), which falls into “Moderate.” This monotonic decrease means most of the useful similarity is at fine scales; once you average over wider neighborhoods, the score is diluted. That is exactly what we expect when precipitation placement is terrain-locked and well aligned locally: the more you smooth, the more you mix matched peaks with surrounding mismatches and background, lowering the score.</p></li>
<li><p>On the individual components side, both maxima components are relatively strong at small scales and only gently decline with L, while the minima components are weaker and degrade more.</p></li>
<li><p>Observation and forecast maxima start around 0.65–0.70 at L=0 and remain comparatively high, ending roughly 0.55–0.60 by L=20. This says the model and observations share the same locations of intense orographic rainfall cores; peaks in the forecast collocate with peaks in the observations and vice versa. In other words, the event’s maxima are captured well.</p></li>
<li><p>Observation minima declines markedly from about 0.55 at L=0 to ~0.25 by L=20. This asymmetry indicates that many observed dry areas are not dry in the forecast (false alarms/light-precip “fill-in”). It’s a signature of a wet bias or drizzle contamination in the forecast field, which becomes more apparent as neighborhoods grow.</p></li>
<li><p>Forecast minima is moderate and fairly stable (roughly 0.55 down to ~0.45). Forecast dry zones find reasonable counterparts in the observations, but not as strongly as the maxima do.</p></li>
</ul>
</section>
<section id="summary-of-agrement-scales-for-the-orographically-driven-case" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-agrement-scales-for-the-orographically-driven-case">Summary of agrement scales for the orographically driven case</h2>
<ul>
<li><p>The field plots show that precipitation is localized, with one strong maximum in the northwest corner and some weaker cores elsewhere. The model produces precipitation in broadly similar regions but introduces additional maxima, especially in the southeast, which were not observed.</p></li>
<li><p>The agreeent scales map shows mostly brown/red shades (small scales: 0–5 grid points), indicating that agreement is reached at very fine neighborhood sizes across much of the domain. This implies that the forecast and observed precipitation structures align closely, and only minimal spatial tolerance is needed. The small patches of lighter colors (10–20+) indicate localized zones where misplacement or wrong maxima reduce skill, requiring broader neighborhoods.</p></li>
<li><p>The histogram has an extremely sharp spike at very small scales (0–3 grid points). Almost the entire distribution collapses there, with the mean (red dashed line) at a very low value (~2–3). The long tail toward larger scales is negligible compared to the dominance at fine scales.</p></li>
</ul>
<p>Summary: The forecast does reproduce the existence of orographic rainfall features, but with notable misplacement and some spurious intensity peaks. This suggests that for this case, orographic forcing anchored precipitation so strongly to terrain features that the model reproduced it with high fidelity, unlike the convective case where displacement dominated.</p>
</section>
<section id="summary-table-core-methods" class="level2">
<h2 class="anchored" data-anchor-id="summary-table-core-methods">Summary Table: Core Methods</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Purpose</th>
<th>Key Benefit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>SLX Score</td>
<td>Spatial field pattern matching</td>
<td>Less penalization for small shifts, robust for extremes</td>
</tr>
<tr class="even">
<td>Agreement Scales Score</td>
<td>Scale-dependent skill mapping</td>
<td>Local skill, uncertainty, ensemble spread visualization</td>
</tr>
</tbody>
</table>
</section>
<section id="future-work" class="level2">
<h2 class="anchored" data-anchor-id="future-work">Future work</h2>
<p>Both SLX and the agreement scales between members and observations have been implemented as separate scores within the <code>verify_spatial</code> function in a dedicated branch of <code>harpSpatial</code>. The agreement scales between ensemble member pairs have been implemented outside of <code>verify_spatial</code>, though they still make use of the full <code>harp</code> functionality.</p>
<p>Further optimization is needed to improve computational efficiency. While the current implementation performs reasonably well in smaller model domains, such as the Austrian domain presented here, it becomes significantly slower in larger domains (e.g., the DINI domain used at DMI).</p>
</section>
</section>
<section id="references" class="level1 unnumbered">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-review_dey" class="csl-entry" role="listitem">
Dey, S. et al. 2016. <span>“Review of the Agreement Scales Score.”</span> <a href="https://carlos9917.github.io/oper-harp-verif/ACCORD_VS_202507/docs/review_dey/dey_agreement_scales_presentation.html">https://carlos9917.github.io/oper-harp-verif/ACCORD_VS_202507/docs/review_dey/dey_agreement_scales_presentation.html</a>.
</div>
<div id="ref-dey_validation" class="csl-entry" role="listitem">
Peralta, C. 2025a. <span>“Validation of the Agreement Scales Implementation.”</span> <a href="https://carlos9917.github.io/oper-harp-verif/ACCORD_VS_202507/docs/review_dey/agreement_scales_validation.html">https://carlos9917.github.io/oper-harp-verif/ACCORD_VS_202507/docs/review_dey/agreement_scales_validation.html</a>.
</div>
<div id="ref-slx_validation" class="csl-entry" role="listitem">
———. 2025b. <span>“Validation of the SLX Score Implementation.”</span> <a href="https://carlos9917.github.io/oper-harp-verif/ACCORD_VS_202507/docs/review_sass/slx_validation.html">https://carlos9917.github.io/oper-harp-verif/ACCORD_VS_202507/docs/review_sass/slx_validation.html</a>.
</div>
<div id="ref-slx_presentation" class="csl-entry" role="listitem">
Sass, B. H. 2021. <span>“Review of the SLX Score.”</span> <a href="https://carlos9917.github.io/oper-harp-verif/ACCORD_VS_202507/docs/review_sass/slx_presentation.html">https://carlos9917.github.io/oper-harp-verif/ACCORD_VS_202507/docs/review_sass/slx_presentation.html</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>